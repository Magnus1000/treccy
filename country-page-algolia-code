<script>
// Globals and Configuration
console.log("Script Initiated");

const algoliaConfig = {
    appId: "CWUIX0EWFE",
    apiKey: "4cd4c82105f395affbc472c07a9789c8",
    indexName: 'treccy_races_all'
};

// Date formatting function
function formatDate(dateString) {
    const date = new Date(dateString);
    const day = date.getDate();
    const month = date.toLocaleString('en-US', { month: 'short' });
    const year = date.getFullYear().toString().substr(-2);
    const formattedDate = `${day} ${month} ${year}`;
    
    console.log("Formatted date:", formattedDate);
    return formattedDate;
}

// Searches Algolia with Country filter
async function fetchAlgoliaResults(country) {
    console.log(`Fetching Algolia Results for country: ${country}...`);

    const searchClient = algoliasearch(algoliaConfig.appId, algoliaConfig.apiKey);
    const index = searchClient.initIndex(algoliaConfig.indexName);

    // Let's log the filter to make sure it's what we expect
    const filter = `country_ag:${country}`;
    console.log("Filter being applied:", filter);

    // Applying the country filter, using "country_ag" as the field name in Algolia
    const results = await index.search('', {
        filters: filter,
        hitsPerPage: 20
    });

    console.log(`Algolia Search Results for ${country}:`, results);
    return results.hits;
}

// Load Algolia Results for a specific country
async function loadAlgoliaResultsToDiv(country) {
    console.log(`Fetching and Displaying Algolia Results in Div for country: ${country}...`);

    const results = await fetchAlgoliaResults(country);
    const algoliaRacesDiv = document.getElementById('algoliaRaces');
    algoliaRacesDiv.innerHTML = '';  // Clear any previous data

    results.forEach(result => {
        const formattedDate = formatDate(result.date_ag); // Format the date using the function
        
        // Rest of the HTML template goes here
        // ...

        algoliaRacesDiv.innerHTML += raceCardHTML;
    });
}

// Get the country from the URL and capitalize the first letter
const country = window.location.pathname.split('/')[2];
const capitalizedCountry = country.charAt(0).toUpperCase() + country.slice(1);

// Calling the function to load Algolia results into the div for the specific country
loadAlgoliaResultsToDiv(capitalizedCountry);
</script>
