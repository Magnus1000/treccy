<script>
// Globals and Configuration
console.log("Script Initiated");

const algoliaConfig = {
    appId: "CWUIX0EWFE",
    apiKey: "4cd4c82105f395affbc472c07a9789c8",
    indexName: 'treccy_races_all'
};

// Date formatting function
function formatDate(dateString) {
    const date = new Date(dateString);
    const day = date.getDate();
    const month = date.toLocaleString('en-US', { month: 'short' });
    const year = date.getFullYear().toString().substr(-2);
    const formattedDate = `${day} ${month} ${year}`;
    
    console.log("Formatted date:", formattedDate);
    return formattedDate;
}

// Searches Algolia with Country filter
async function fetchAlgoliaResults(country) {
    console.log(`Fetching Algolia Results for country: ${country_ag}...`);

    const searchClient = algoliasearch(algoliaConfig.appId, algoliaConfig.apiKey);
    const index = searchClient.initIndex(algoliaConfig.indexName);

    // Applying the country filter
    const results = await index.search('', {
        filters: `Country:${country_ag}`,
        hitsPerPage: 20
    });

    console.log(`Algolia Search Results for ${country_ag}:`, results);
    return results.hits;
}

// Load Algolia Results for a specific country
async function loadAlgoliaResultsToDiv(country) {
    console.log(`Fetching and Displaying Algolia Results in Div for country: ${country_ag}...`);

    const results = await fetchAlgoliaResults(country_ag);
    const algoliaRacesDiv = document.getElementById('algoliaRaces');
    algoliaRacesDiv.innerHTML = '';  // Clear any previous data

    results.forEach(result => {
        const formattedDate = formatDate(result.date_ag); // Format the date using the function

        const raceCardHTML = `
        <div class="race-card">
            <div class="race-card-top-block">
                <a href="/races/${result.slug_ag}" class="race-card-image-link-block w-inline-block">
                    <img src="https://global-uploads.webflow.com/64ccebfb87c59cf5f3e54ed9/64d577b91781ce52b98c4e29_64cd3b3ec7904911140a6546_763awew3skd5y0hb3dhh8eh2bx3d3g8k-p-500.png" loading="lazy" alt="${result.name_ag}" class="race-card-image">
                </a>
                <div class="race-discipline-tags-wrapper">
                    <div class="race-discipline-tags-list">
                        <div class="race-discipline-tag-div">
                            <img src="https://global-uploads.webflow.com/64ccebfb87c59cf5f3e54ed9/64d2833f7badb96d1c86df8b_running-icon-50.svg" loading="lazy" alt="" class="race-discipline-icon">
                        </div>
                    </div>
                </div>
                <div class="heart-icon-div">
                    <div class="heart-icon w-embed">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" aria-hidden="true" role="presentation" focusable="false">
                            <path d="M16 28c7-4.73 14-10 14-17a6.98 6.98 0 0 0-7-7c-1.8 0-3.58.68-4.95 2.05L16 8.1l-2.05-2.05a6.98 6.98 0 0 0-9.9 0A6.98 6.98 0 0 0 2 11c0 7 7 12.27 14 17z"></path>
                        </svg>
                    </div>
                </div>
            </div>
            <a href="/races/${result.slug_ag}" id="textLinkblock" class="popup-text-link-block w-inline-block">
                <div class="race-card-heading-div">
                    <h4 id="raceNameid" class="race-card-heading">${result.name_ag}</h4>
                    <h4 id="raceDistanceid" class="race-card-heading-right">${result.Distance}</h4>
                </div>
                <div class="race-card-location-tags">
                    <div class="race-card-location-tags-left-column">
                        <h5 id="raceCityid" class="race-grid-location">${result.city_ag}</h5>
                        <h5 class="race-grid-location comma">,</h5>
                        <h5 id="raceCountryid" class="race-grid-location">${result.country_ag}</h5>
                    </div>
                </div>
                <div id="racecardDate" class="race-card-date-text">${formattedDate}</div>
            </a>
        </div>
    `;
    algoliaRacesDiv.innerHTML += raceCardHTML;
    });
}

// Get the country from the URL and capitalize the first letter
const country = window.location.pathname.split('/')[2];
const capitalizedCountry = country.charAt(0).toUpperCase() + country.slice(1);

// Calling the function to load Algolia results into the div for the specific country
loadAlgoliaResultsToDiv(capitalizedCountry);
</script>
