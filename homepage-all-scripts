<style>
input[type="checkbox"]{
    display: none;
  }
</style>

<!-- Font Awesome CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

<script>
document.addEventListener('DOMContentLoaded', function() {
    const profilePill = document.getElementById('profile-pill');
    const profileDropdown = document.getElementById('profile-dropdown');

    // Initially, let's assume you want the dropdown hidden.
    profileDropdown.style.display = 'none';

    profilePill.addEventListener('click', function() {
        if (profileDropdown.style.display === 'none' || profileDropdown.style.display === '') {
            profileDropdown.style.display = 'flex';
        } else {
            profileDropdown.style.display = 'none';
        }
    });
});
</script>

<style>
  .active-vertical-menu-item,
  .active-horizontal-menu-item {
    font-weight: 700;
  }
  
  .heart-icon {
  display: block;
  height: 24px;
  width: 24px;
  fill: rgba(0, 0, 0, 0.5);
  stroke: rgba(0, 0, 0, 0.5); /* Default stroke color if the variable is not defined */
  stroke-width: 2;
  overflow: visible;
}

.heart-icon.saved {
  fill: #0a0f0d; /* Saved color */
  stroke: #0a0f0d;
}
  
  .heart-icon-large {
  display: block;
  height: 44px;
  width: 44px;
  fill: rgba(0, 0, 0, 0.5);
  stroke: rgba(0, 0, 0, 0.5); /* Default stroke color if the variable is not defined */
  stroke-width: 2;
  overflow: visible;
}

.heart-icon-large.saved {
  fill: #0a0f0d; /* Saved color */
  stroke: #0a0f0d;
}

</style>

<!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-P6GBQ545');</script>
<!-- End Google Tag Manager -->

<!-- Mapbox styles and scripts -->
<link href='https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.css' rel='stylesheet' />
<script src='https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.js'></script>
<link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.0/mapbox-gl-geocoder.css" type="text/css" />
<script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.0/mapbox-gl-geocoder.min.js"></script>

<!-- UUID -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/uuid/8.3.2/uuidv4.min.js"></script>

<!-- Algolia script -->
<script src="https://cdn.jsdelivr.net/npm/algoliasearch@4.5.1/dist/algoliasearch-lite.umd.js"></script>

<!-- Location Search Dropdown -->
<style>
.suggestions-dropdown {
    display: none; /* Hidden by default */
}

.suggestions-dropdown.active {
    display: flex; /* Shown when there are suggestions */
}

/* Hide the default radio button */
.type-radio-button {
  appearance: none;
  -webkit-appearance: none;
  -moz-appearance: none;
  width: 16px;
  height: 16px;
  border: 1px solid #69706d;
  outline: none;
  position: relative;
  margin-right: 8px; /* Space between the radio and label */
  vertical-align: middle;
  border-radius: 50%;
}

/* Style for the unchecked state */
.type-radio-button::before {
  content: "";
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 10px;
  height: 10px;
  background-color: #fff;
  border-radius: 50%;
}

/* Style for the checked state */
.type-radio-button:checked::before {
  background-color: #0a0f0d; /* Selected color */
  border: 1px solid #0a0f0d;
}

.heart-icon {
  display: block;
  height: 24px;
  width: 24px;
  fill: rgba(0, 0, 0, 0.5);
  stroke: rgba(0, 0, 0, 0.5); /* Default stroke color if the variable is not defined */
  stroke-width: 2;
  overflow: visible;
}

.heart-icon.saved {
  fill: #0a0f0d; /* Saved color */
  stroke: #0a0f0d;
}

/* Style Mapbox Popup */
.mapboxgl-popup-close-button {
    left: 0;
    right:auto;
    }
    
.mapboxgl-popup-tip {
    display: none;
}

.mapboxgl-popup-content {
    padding: 0px!important;
    border-radius:5px;
    width: 300px;
    max-width: 500px;
}

.mapboxgl-popup.mapboxgl-popup-anchor-bottom {
    max-width: 300px;
}
</style>

<script>
// Globals and Configuration
console.log("Script Initiated");

let currentMarkers = [];
const mapboxToken = 'pk.eyJ1IjoibWFnbnVzMTk5MyIsImEiOiJjbGwyOHUxZTcyYTc1M2VwZDhzZGY3bG13In0._jM6tBke0CyM5_udTKGDOQ';
const algoliaConfig = {
    appId: "CWUIX0EWFE",
    apiKey: "4cd4c82105f395affbc472c07a9789c8",
    indexName: 'treccy_races_all'
};

const disciplineMarkers = {
    'swimming': 'https://uploads-ssl.webflow.com/64ccebfb87c59cf5f3e54ed9/64d2833f1995f2e23c39eacc_swimming-icon-50.svg',
    'paddling': 'https://uploads-ssl.webflow.com/64ccebfb87c59cf5f3e54ed9/64d28340c9aa33055043be71_paddling-icon-50.svg',
    'running': 'https://uploads-ssl.webflow.com/64ccebfb87c59cf5f3e54ed9/64d2833f7badb96d1c86df8b_running-icon-50.svg',
    'cycling': 'https://uploads-ssl.webflow.com/64ccebfb87c59cf5f3e54ed9/64d2833fff1d33088ebee8f4_cycling-icon-50.svg',
    'default': 'https://uploads-ssl.webflow.com/64ccebfb87c59cf5f3e54ed9/64ce497c38241ed462982298_favicon32.jpg'
};

// 1) Checks User Location
async function getLocation() {
    console.log("Getting User Location...");
    return new Promise((resolve, reject) => {
        if (!navigator.geolocation) {
            reject('Geolocation is not supported by your browser.');
        } else {
            navigator.geolocation.getCurrentPosition((position) => {
                resolve({
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                });
            }, () => {
                reject('Unable to retrieve your location.');
            });
        }
    });
}

// 2) Searches Algolia
async function fetchAlgoliaResults(lat, lng) {
    console.log("Fetching Algolia Results...");

    const filters = [];
    const searchClient = algoliasearch(algoliaConfig.appId, algoliaConfig.apiKey);
    const index = searchClient.initIndex(algoliaConfig.indexName);

    const disciplineFilterCheckbox = document.getElementById('disciplineFilter_checkbox');
    if (disciplineFilterCheckbox && disciplineFilterCheckbox.checked) {
        const filterValue = disciplineFilterCheckbox.getAttribute('filter-value');
        if (filterValue) {
            filters.push(`Disciplines=${filterValue}`);
        }
    }

    console.log("Filters being sent to Algolia:", filters);
    
    const debugURL = `https://${algoliaConfig.appId}-dsn.algolia.net/1/indexes/${algoliaConfig.indexName}/query?hitsPerPage=20&aroundLatLng=${lat},${lng}&aroundRadius=5000000&filters=${filters.join(' AND ')}`;
    console.log("Debug URL with parameters:", debugURL);

    const results = await index.search('', {
        hitsPerPage: 20,
        aroundLatLng: `${lat},${lng}`,
        aroundRadius: 5000000,
        filters: filters.join(' AND ')
    });

    console.log("Algolia Search Results:", results);
    return results.hits;
}

// 3) Returns results to the algoliaRaces grid
// Date formatting function
function formatDate(dateString) {
    const date = new Date(dateString);
    const day = date.getDate();
    const month = date.toLocaleString('en-US', { month: 'short' });
    const year = date.getFullYear().toString().substr(-2);
    const formattedDate = `${day} ${month} ${year}`;
    
    console.log("Formatted date:", formattedDate);
    return formattedDate;
}

// Load Algolia Results
async function loadAlgoliaResultsToDiv(lat, lng) {
    console.log("Fetching and Displaying Algolia Results in Div...");

    const results = await fetchAlgoliaResults(lat, lng);

    const algoliaRacesDiv = document.getElementById('algoliaRaces');
    algoliaRacesDiv.innerHTML = '';  // Clear any previous data

    results.forEach(result => {
        const formattedDate = formatDate(result.date_ag); // Format the date using the function

        const raceCardHTML = `
        <div class="race-card">
            <div class="race-card-top-block">
                <a href="/races/${result.slug_ag}" class="race-card-image-link-block w-inline-block">
                    <img src="${result.photo_main_ag}" loading="lazy" alt="${result.name_ag}" class="race-card-image">
                </a>
                <div class="race-discipline-tags-wrapper">
                    <div class="race-discipline-tags-list">
                        <div class="race-discipline-tag-div">
                            <img src="https://global-uploads.webflow.com/64ccebfb87c59cf5f3e54ed9/64d2833f7badb96d1c86df8b_running-icon-50.svg" loading="lazy" alt="" class="race-discipline-icon">
                        </div>
                    </div>
                </div>
                <div class="heart-icon-div">
                    <div class="heart-icon w-embed">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" aria-hidden="true" role="presentation" focusable="false">
                            <path d="M16 28c7-4.73 14-10 14-17a6.98 6.98 0 0 0-7-7c-1.8 0-3.58.68-4.95 2.05L16 8.1l-2.05-2.05a6.98 6.98 0 0 0-9.9 0A6.98 6.98 0 0 0 2 11c0 7 7 12.27 14 17z"></path>
                        </svg>
                    </div>
                </div>
            </div>
            <a href="/races/${result.slug_ag}" id="textLinkblock" class="card-text-link-block w-inline-block">
                <div class="race-card-heading-div">
                    <h4 id="raceNameid" class="race-card-heading">${result.name_ag}</h4>
                    <h4 id="raceDistanceid" class="race-card-heading-right">${result.distance_ag}</h4>
                </div>
                <div class="race-card-location-tags">
                    <div class="race-card-location-tags-left-column">
                        <h5 id="raceCityid" class="race-grid-location">${result.city_ag}</h5>
                        <h5 class="race-grid-location comma">,</h5>
                        <h5 id="raceCountryid" class="race-grid-location">${result.country_ag}</h5>
                    </div>
                </div>
                <div id="racecardDate" class="race-card-date-text">${formattedDate}</div>
            </a>
        </div>
    `;
    algoliaRacesDiv.innerHTML += raceCardHTML;
});
}
</script>

<script>
// 4) Displays results on the map
function removeExistingMarkers() {
    for (const marker of currentMarkers) {
        marker.remove();
    }
    currentMarkers = [];
}

function createMarkerOnMap(map, result) {
    let markerImageUrl;
    
    if (result.disciplines_ag.length === 1) {
        let disciplineKey = result.disciplines_ag[0].toLowerCase();
        // Check if the discipline key exists in the disciplineMarkers object
        if (disciplineMarkers[disciplineKey]) {
            markerImageUrl = disciplineMarkers[disciplineKey];
        } else {
            // Log a warning to the console if the key is not found
            console.warn(`Discipline key not found: ${disciplineKey}`);
            markerImageUrl = 'https://uploads-ssl.webflow.com/64ccebfb87c59cf5f3e54ed9/64ce497c38241ed462982298_favicon32.jpg';
        }
    } else {
        // Use a generic marker for multiple disciplines
        markerImageUrl = 'https://uploads-ssl.webflow.com/64ccebfb87c59cf5f3e54ed9/64ce497c38241ed462982298_favicon32.jpg';
    }

    // Creating the disciplines div
    let disciplinesDiv = '';
    result.disciplines_ag.forEach(discipline => {
        disciplinesDiv += `<div class="map-popup-discipline">${discipline}</div>`;
    });

    // Formatted date
    const formattedDate = formatDate(result.date_ag);

    const popup = new mapboxgl.Popup({ offset: 25 }).setHTML(`
        <div class="map-popup-div">
            <div class="map-popup-image-div">
                <a href="/races/${result.slug_ag}" class="map-popup-link-block w-inline-block">
                    <img src="${result.photo_main_ag}" loading="lazy" alt="" class="map-popup-image">
                </a>
                <div class="map-popup-discipline-div">${disciplinesDiv}</div>
                <div class="heart-icon-div"><div class="heart-icon w-embed"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" aria-hidden="true" role="presentation" focusable="false">
  <path d="M16 28c7-4.73 14-10 14-17a6.98 6.98 0 0 0-7-7c-1.8 0-3.58.68-4.95 2.05L16 8.1l-2.05-2.05a6.98 6.98 0 0 0-9.9 0A6.98 6.98 0 0 0 2 11c0 7 7 12.27 14 17z"></path>
</svg></div>
                </div>
            </div>
            <a href="/races/${result.slug_ag}" class="link-block w-inline-block">
                <div class="map-popup-header-div">
                    <div class="map-popup-header">${result.name_ag}</div>
                </div>
                <div class="map-popup-country-and-date-div">
                    <div class="map-popup-header-country-div">
                        <div class="map-popup-city-text">${result.city_ag}</div>
                        <div class="map-popup-comma">, </div>
                        <div class="map-popup-country-text">${result.country_ag}</div>
                    </div>
                    <div class="map-popup-date-div">
                        <div class="map-popup-date-text">${formattedDate}</div>
                    </div>
                </div>
            </a>
        </div>
    `);

    const customMarker = new Image(50, 50);
    customMarker.src = markerImageUrl;

    const marker = new mapboxgl.Marker(customMarker)
        .setLngLat([result._geoloc.lng, result._geoloc.lat])
        .setPopup(popup)
        .addTo(map);

    currentMarkers.push(marker);
}



async function displayMapWithResults(lat, lng) {
    console.log("Displaying Map with Results...");
    
    const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/magnus1993/cll28qk0n006a01pu7y9h0ouv',
        center: [lng, lat],
        zoom: 10,
        accessToken: mapboxToken  
    });

    // Fetch Algolia Results
    const results = await fetchAlgoliaResults(lat, lng);
    
    // Clear any existing markers
    removeExistingMarkers();

    // Display Algolia results on the map
    results.forEach(result => {
        createMarkerOnMap(map, result);
    });

    map.resize();
}
</script>

<script>
// Function to update the URL with the view type
function updateViewInUrl(viewType) {
  const url = new URL(window.location.href);
  url.searchParams.set('view', viewType);
  history.replaceState(null, null, url.toString());
  console.log(`URL updated with view: ${viewType}`);
}

// 5) Listens to the toggle events to hide/display the map and grid
document.getElementById('showMap').addEventListener('click', async function() {
    console.log("Show Map Button Clicked...");

    const mapContainer = document.getElementById('map');
    mapContainer.style.display = 'flex';  // Show the map container

    const showListrow = document.getElementById('showListrow');
    showListrow.style.display = 'flex';  // Show the Show List row

    const showMaprow = document.getElementById('showMaprow');
    showMaprow.style.display = 'none';  // Hide the Show Map row

    const raceListgrid = document.getElementById('raceListgrid');
    raceListgrid.style.display = 'none';  // Hide the race list grid

    const userLocation = await getLocation();
    displayMapWithResults(userLocation.lat, userLocation.lng);

    updateViewInUrl('map');
});

document.getElementById('showList').addEventListener('click', async function() {
    console.log("Show List Button Clicked...");

    const mapContainer = document.getElementById('map');
    mapContainer.style.display = 'none';  // Hide the map container

    const showListrow = document.getElementById('showMaprow');
    showListrow.style.display = 'flex';  // Show the Show Map row

    const showMaprow = document.getElementById('showListrow');
    showMaprow.style.display = 'none';  // Hide the Show List row

    const raceListgrid = document.getElementById('raceListgrid');
    raceListgrid.style.display = 'flex';  // Show the race list grid

    updateViewInUrl('list'); 

});

// Function to load the view from URL parameters
function loadViewFromUrlParams() {
  const urlSearchParams = new URLSearchParams(window.location.search);
  const viewType = urlSearchParams.get('view');
  if (viewType === 'map') {
    document.getElementById('showMap').click();
  } else if (viewType === 'list') {
    document.getElementById('showList').click();
  }
  console.log(`Loaded view from URL: ${viewType}`);
}

// 6) Check the URL parameters and preset the filter if there are any filters already set
function checkAndPresetFilters() {
  console.log("Checking and Presetting Filters from URL Params...");

  const urlSearchParams = new URLSearchParams(window.location.search);

  // Handle discipline filters (can be multiple)
  Array.from(urlSearchParams.keys()).forEach(key => {
    if (key.startsWith('discipline')) {
      const disciplineValue = urlSearchParams.get(key);
      const checkbox = document.querySelector(`input[filter-value='${disciplineValue}']`);
      if (checkbox) {
        checkbox.checked = true;
        const parentLabel = checkbox.closest(".w-checkbox.checkbox-buttons");
        parentLabel.classList.add("active-filter");
      }
    }
  });

  // Handle minDist filter
  const minDist = urlSearchParams.get('minDist');
  if (minDist) {
    const minDistInput = document.getElementById('minimum-distance');
    if (minDistInput) {
      minDistInput.value = minDist;
    }
  }

  // Handle maxDist filter
  const maxDist = urlSearchParams.get('maxDist');
  if (maxDist) {
    const maxDistInput = document.getElementById('maximum-distance');
    if (maxDistInput) {
      maxDistInput.value = maxDist;
    }
  }

  // Handle locationRange filter
  const locationRange = urlSearchParams.get('locationRange');
  if (locationRange) {
    const locationRangeInput = document.getElementById('location_range');
    if (locationRangeInput) {
      locationRangeInput.value = locationRange;
    }
  }

  // Handle fromDate filter
  const fromDate = urlSearchParams.get('fromDate');
  if (fromDate) {
    const fromDateInput = document.getElementById('dateFrom');
    if (fromDateInput) {
      fromDateInput.value = fromDate;
    }
  }

  // Handle toDate filter
  const toDate = urlSearchParams.get('toDate');
  if (toDate) {
    const toDateInput = document.getElementById('dateTo');
    if (toDateInput) {
      toDateInput.value = toDate;
    }
  }

  // Handle type filter
  const type = urlSearchParams.get('type');
  if (type) {
    const radioButton = document.getElementById(type);
    if (radioButton) {
      radioButton.checked = true;
    }
  }

  // Handle location filter
  const location = urlSearchParams.get('location');
  const lat = urlSearchParams.get('lat');
  const lon = urlSearchParams.get('lon');
  if (location) {
    const searchBarElement = document.getElementById('search-bar');
    if (searchBarElement) {
      searchBarElement.value = location;
      if (lat) searchBarElement.setAttribute('data-lat', lat);
      if (lon) searchBarElement.setAttribute('data-lon', lon);
    }
  }
}

// Load View Based on View Params
loadViewFromUrlParams();
</script>

<script>
// On Page Load Logic
document.addEventListener("DOMContentLoaded", async function() {
    console.log("Page Loaded");

    const userLocation = await getLocation();
    console.log("User Location:", userLocation);

    // Load Algolia Results to the Grid
    loadAlgoliaResultsToDiv(userLocation.lat, userLocation.lng);

    // Display Results on the Map
    displayMapWithResults(userLocation.lat, userLocation.lng);

    // Checkbox Styling
    initializeCheckboxStyling();

    // Listen to Filter Form Submission
    document.getElementById('filterForm').addEventListener('submit', (event) => {
        event.preventDefault();
        updateURLWithFilters();
        console.log("Filter form submitted and URL updated.");
        displayMapWithResults(userLocation.lat, userLocation.lng);

        // Hide the modal with ID "filterForm"
        document.getElementById('filterForm').style.display = 'none';
    });

    // Check and Preset Filters from URL Params
    checkAndPresetFilters();
});
</script>

<script>
const searchInput = document.getElementById('search-bar');
const suggestionsBox = document.getElementById('suggestions');

const sessionToken = uuidv4(); // Assigning the generated UUID to sessionToken
console.log("Generated session token:", sessionToken);

// Mapbox Access Token
const accessToken = 'pk.eyJ1IjoibWFnbnVzMTk5MyIsImEiOiJjbGwyOHUxZTcyYTc1M2VwZDhzZGY3bG13In0._jM6tBke0CyM5_udTKGDOQ';

// Attach event listener to search input
searchInput.addEventListener('input', (e) => {
    const query = e.target.value.trim();

    if (query === "") {
        suggestionsBox.innerHTML = "";
        suggestionsBox.classList.remove('active'); // Hide suggestions
        return; // Exit if the query is empty
    }

    // Call the Mapbox Geocoding endpoint
    fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${query}.json?access_token=${accessToken}&types=place,region,country`)
        .then(response => response.json())
        .then(data => {
            // Check if features are available
            if (data.features && data.features.length > 0) {
                suggestionsBox.classList.add('active'); // Show suggestions
                suggestionsBox.innerHTML = "";

                const suggestions = data.features;
                suggestions.forEach(suggestion => {
                    // Create suggestion text
                    const placeName = suggestion.place_name;
                    const suggestionItem = document.createElement('div');
                    suggestionItem.classList.add('suggestion-item'); // Assign class
                    
                    // Create and add location icon
                    const iconElement = document.createElement('img');
                    iconElement.src = 'https://uploads-ssl.webflow.com/64ccebfb87c59cf5f3e54ed9/64d2833fff1d33088ebee8f4_cycling-icon-50.svg'; // Change this path
                    suggestionItem.appendChild(iconElement);

                    suggestionItem.appendChild(document.createTextNode(placeName));
                    suggestionsBox.appendChild(suggestionItem);

                    // Add click event listener to each suggestion
                    suggestionItem.addEventListener('click', () => {
                        // Populate the search bar with the selected suggestion
                        searchInput.value = placeName;
                        // Store latitude and longitude as attributes
                        searchInput.setAttribute('data-lat', suggestion.geometry.coordinates[1]);
                        searchInput.setAttribute('data-lon', suggestion.geometry.coordinates[0]);
                        // Clear the suggestions
                        suggestionsBox.innerHTML = "";
                        suggestionsBox.classList.remove('active'); // Hide suggestions
                    });
                });
            } else {
                suggestionsBox.classList.remove('active'); // Hide suggestions
            }
        })
        .catch(error => console.error(error));
});
</script>

<script>
// Checkbox Styling
function initializeCheckboxStyling() {
    console.log("Adjusting Checkbox Styling...");

    function updateCheckboxStyling() {
        const spanElement = this.nextElementSibling;
        const parentLabel = spanElement.closest(".w-checkbox.checkbox-buttons");
        if (this.checked) {
            parentLabel.classList.add("active-filter");
        } else {
            parentLabel.classList.remove("active-filter");
        }
    }

    const checkboxes = document.querySelectorAll(".w-checkbox.checkbox-buttons input[type='checkbox']");
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener("change", updateCheckboxStyling);
        updateCheckboxStyling.call(checkbox);
    });
}

    // Update URL params with filters 
    function updateURLWithFilters() {
    // Get all checkboxes with the class 'disciplinefilter_checkbox'
    const disciplineFilterCheckboxes = document.querySelectorAll('.disciplinefilter_checkbox');

    // Get discipline values from checked checkboxes
    const selectedDisciplines = Array.from(disciplineFilterCheckboxes)
      .filter(checkbox => checkbox.checked)
      .map(checkbox => checkbox.getAttribute('filter-value'));

    // Log the selected disciplines to the console
    console.log('Selected discipline filters:', selectedDisciplines);

    // Distance filters
    const minimumDistance = document.getElementById('minimum-distance').value;
    const maximumDistance = document.getElementById('maximum-distance').value;

    // Location range filter
    const locationRange = document.getElementById('location_range').value;

    // Date filters
    const dateFrom = document.getElementById('dateFrom').value;
    const dateTo = document.getElementById('dateTo').value;

    // Type filter
    const selectedType = document.querySelector('input[name="type"]:checked');

    // Location search bar value
    
    // Get the search input element
    const searchBarElement = document.getElementById('search-bar');
    
    // Get the value and lat-lon attributes
    const searchBarValue = searchBarElement.value;
    const searchBarLat = searchBarElement.getAttribute('data-lat');
    const searchBarLon = searchBarElement.getAttribute('data-lon');

    let params = new URLSearchParams();

    // Add selected disciplines to URL parameters
  selectedDisciplines.forEach((discipline, index) => {
      params.append(`discipline${index}`, discipline);
  });

    if (minimumDistance) {
        params.set('minDist', minimumDistance);
    }

    if (maximumDistance) {
        params.set('maxDist', maximumDistance);
    }

    if (locationRange) {
        params.set('locationRange', locationRange);
    }

    if (dateFrom) {
        params.set('fromDate', dateFrom);
    }

    if (dateTo) {
        params.set('toDate', dateTo);
    }

    if (selectedType) {
    params.set('type', selectedType.value);
    }

    
    if (searchBarValue) {
        params.set('location', searchBarValue);
    }

    if (searchBarLat && searchBarLon) {
        params.set('lat', searchBarLat);
        params.set('lon', searchBarLon);
    }

  // Log the final parameters to the console
  console.log('Final URL parameters:', params.toString());

    // Update the URL without causing a page reload
    history.pushState({}, '', '?' + params.toString());
}
</script>

<script>
// Function to get the query parameters from the URL
function getQueryParams() {
  const queryParams = {};
  const queryString = window.location.search.substring(1);
  const pairs = queryString.split('&');
  pairs.forEach(pair => {
    const [key, value] = pair.split('=');
    queryParams[key] = decodeURIComponent(value);
  });
  return queryParams;
}

// Function to get the email from the form
function getEmail() {
  // Assuming that the email field has an ID 'email'
  const emailElement = document.getElementById('email');
  return emailElement ? emailElement.value : '';
}

// Function to validate email format
function isValidEmail(email) {
  // Regular expression to check the email format
  const regex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
  return regex.test(email);
}

// Function to send the webhook
function sendWebhook(email, params) {
  // Check if the email is valid
  if (!isValidEmail(email)) {
    console.error('Invalid email:', email);
    return; // Exit the function if the email is not valid
  }

  // Construct the payload with email and parameters
  const payload = {
    email,
    params
  };

  // Webhook URL
  const url = 'https://hook.us1.make.com/chr1792n4xwbkd96ea3zhcdmnn9khntl';

   // Send a POST request to the webhook
  fetch(url, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(payload)
  })
  .then(response => response.text())
  .then(data => {
    console.log('Webhook response:', data);

    // Show the success message
    const successMessage = document.getElementById('success-message-slide-in');
    if (successMessage) {
      successMessage.style.display = 'block';

      // Hide the success message after 5 seconds (5000 milliseconds)
      setTimeout(() => {
        successMessage.style.display = 'none';
      }, 5000);
    }
  })
  .catch(error => console.error('Error sending webhook:', error));
}

// Assuming the form containing the email input has the ID 'email-form'
document.getElementById('email-form').addEventListener('submit', function(e) {
  // Prevent the default form submission behavior
  e.preventDefault();
});

document.getElementById('submit_email_initial').addEventListener('click', function() {
  // Get the email from the form
  const email = getEmail();
  
  // Get the URL parameters
  const params = getQueryParams();

  // Log the details to the console
  console.log('Sending webhook with email:', email, 'and parameters:', params);

  // Send the webhook
  sendWebhook(email, params);
});
</script>

<script>
document.getElementById('copy_to_clipboard').addEventListener('click', function() {
  // Get the current page's URL
  const urlToCopy = window.location.href;

  // Use the Clipboard API to write the URL to the clipboard
  navigator.clipboard.writeText(urlToCopy).then(() => {
    console.log('URL copied to clipboard:', urlToCopy);
  }).catch(err => {
    console.error('Failed to copy URL to clipboard:', err);
  });

  // Get the popup element by ID
  const popup = document.getElementById('copy_to_clipboard_popin_slider');

  // Check if the popup element exists
  if (popup) {
    // Show the popup
    popup.style.display = 'block';
    popup.style.opacity = 1; // Make it fully visible

    // Set a timeout to fade out the popup after 5 seconds (5000 milliseconds)
    setTimeout(() => {
      // You can use CSS transitions for a smooth fade effect
      popup.style.transition = 'opacity 1s ease-out';
      popup.style.opacity = 0;

      // Optionally, hide the popup completely after the fade effect is finished
      setTimeout(() => {
        popup.style.display = 'none';
      }, 1000); // Match the duration of the transition (1s in this case)
    }, 5000);
  }
});
</script>

<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/@algolia/autocomplete-theme-classic"
/>
<style>
  :root {
    --aa-icon-size: 80px;
  }
</style>
<script src="https://cdn.jsdelivr.net/npm/@algolia/autocomplete-js"></script>
<script src="https://cdn.jsdelivr.net/npm/preact/dist/preact.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/algoliasearch@4.5.1/dist/algoliasearch-lite.umd.js"></script>
<script>
const { autocomplete, getAlgoliaResults } = window['@algolia/autocomplete-js'];
const appId = "CWUIX0EWFE";
const apiKey = "4cd4c82105f395affbc472c07a9789c8"; // Updated API key
const searchClient = algoliasearch(appId, apiKey);
const indexName = "treccy_races_all";

console.log("Initializing Algolia autocomplete..."); // Log initialization

const { setIsOpen } = autocomplete({
    container: "#global-race-search",
    placeholder: "Search this blog",
    detachedMediaQuery: '',
    openOnFocus: true,
    getSources({ query, state }) {
      console.log("Query received:", query); // Log the query

      if (!query) {
        return [];
      }

      return [
        {
          sourceId: "races",
          getItems() {
            console.log("Fetching results from Algolia..."); // Log fetching

            return getAlgoliaResults({
              searchClient,
              queries: [
                {
                  indexName: indexName,
                  query,
                  params: {
                    attributesToSnippet: ['name:10', 'summary:35'],
                    snippetEllipsisText: 'â€¦',
                    hitsPerPage: 5
                  }
                }
              ]
            }).then(results => {
              console.log("Results from Algolia:", results); // Log results
              return results;
            });
          },
            templates: {
              header() {
                return (
                  "Posts"
                );
              },
              item({ item, components, html }) {
                return html`<a class="aa-ItemLink" href="/posts/${item.slug_ag}">
                  <div class="aa-ItemContent">
                    <div class="aa-ItemIcon aa-ItemIcon--alignTop">
                      <a href="/posts/${item.slug.ag}"><img
                        src="${item.photo_main_ag}"
                        alt="${item.name_ag}"
                        width="40"
                        height="40"
                      /></a>
                    </div>
                    <div class="aa-ItemContentBody">
                      <div class="aa-ItemContentTitle">
                        ${components.Snippet({
                          hit: item,
                          attribute: 'name',
                        })}
                      </div>
                      <div class="aa-ItemContentSubtitle">
                        Published in <strong>${item.country_ag}</strong>
                      </div>
                      <div class="aa-ItemContentDescription">
                        ${components.Snippet({
                          hit: item,
                          attribute: 'summary',
                        })}
                      </div>
                    </div>
                  </div>
                </a>`;
              },
              noResults() {
                return "No posts for this query.";
              }
            },
            getItemUrl({ item }) {
              return "/races/" + item.slug_ag;
            },
          }
        ];
      }
    });
  
    console.log("Algolia autocomplete initialized."); // Log completion

    document.addEventListener('keydown', (event) => {
      if (event.metaKey && event.key.toLowerCase() === 'k') {
        setIsOpen(true);
      }
    });
</script>

<script>
  $(document).ready(function() {
  // Listen for click events on the 'filter-open' button.
  $('#filter-open').on('click', function() {
    // Show the modal when the 'filter-open' button is clicked.
    $('#filterForm').show();
  });

  // Listen for click events on the 'filter-close' button.
  $('#filter-close').on('click', function() {
    // Hide the modal when the 'filter-close' button is clicked.
    $('#filterForm').hide();
  });
});
</script>

<script>
  $(document).ready(function() {
    // Get the current page's URL path
    var path = window.location.pathname;

    // Remove any leading or trailing slashes from the path
    path = path.replace(/\/$/, "");
    path = path.substr(1);

    // Find the vertical menu item that corresponds to the current page and add the "active-vertical-menu-item" class
    $(".vertical-menu-item[data-url='" + path + "']").addClass("active-vertical-menu-item");

    // Find the horizontal menu item that corresponds to the current page and add the "active-horizontal-menu-item" class
    $(".horizontal-menu-item[data-url='" + path + "']").addClass("active-horizontal-menu-item");
  });
</script>

<style>
input[type="checkbox"]{
    display: none;
}
  
.w-checkbox.checkbox-buttons.active-filter {
  background-color: black !important;
  color: white !important;
}

</style>
