<script>
// On Page Load Logic
document.addEventListener("DOMContentLoaded", async function() {
    console.log("Page Loaded");

    const userLocation = await getLocation();
    console.log("User Location:", userLocation);

    // Load Algolia Results to the Grid
    loadAlgoliaResultsToDiv(userLocation.lat, userLocation.lng);

    // Display Results on the Map
    displayMapWithResults(userLocation.lat, userLocation.lng);

    // Checkbox Styling
    initializeCheckboxStyling();

    // Listen to Filter Form Submission
    document.getElementById('filterForm').addEventListener('submit', (event) => {
        event.preventDefault();
        updateURLWithFilters();
        console.log("Filter form submitted and URL updated.");
        displayMapWithResults(userLocation.lat, userLocation.lng);

        // Hide the modal with ID "filterForm"
        document.getElementById('filterForm').style.display = 'none';
    });

    // Check and Preset Filters from URL Params
    checkAndPresetFilters();

    // Set Mapbox Access Token
    mapboxgl.accessToken = 'pk.eyJ1IjoibWFnbnVzMTk5MyIsImEiOiJjbGwyOHUxZTcyYTc1M2VwZDhzZGY3bG13In0._jM6tBke0CyM5_udTKGDOQ';
    console.log("Mapbox Access Token Set");

    // Create Geocoder
    var geocoder = new MapboxGeocoder({
        accessToken: mapboxgl.accessToken,
        // Set options if needed
    });
    console.log("Geocoder Created");

    // Get the input field with id 'current_location'
    var currentLocationInput = document.getElementById('current_location');

    // Add an event listener for the 'focus' event
    currentLocationInput.addEventListener('focus', function() {
        console.log("Input Field Focused");
    });

    // Add an event listener for the 'keyup' event
    currentLocationInput.addEventListener('keyup', function() {
        console.log("Key Pressed:", currentLocationInput.value);
    });

    // Add Geocoder to the input field with id 'current_location'
    currentLocationInput.appendChild(geocoder.onAdd());
    console.log("Geocoder Added to Input Field");

    // Optional: Handle the selection event
    geocoder.on('result', function(e) {
        console.log("Address Selected:", e.result); // Log the selected address details
    });
});
</script>

<script>
const searchInput = document.getElementById('search-bar');
const suggestionsBox = document.getElementById('suggestions');

const sessionToken = uuidv4(); // Assigning the generated UUID to sessionToken
console.log("Generated session token:", sessionToken);

// Mapbox Access Token
const accessToken = 'pk.eyJ1IjoibWFnbnVzMTk5MyIsImEiOiJjbGwyOHUxZTcyYTc1M2VwZDhzZGY3bG13In0._jM6tBke0CyM5_udTKGDOQ';

// Attach event listener to search input
searchInput.addEventListener('input', (e) => {
    const query = e.target.value.trim();

    if (query === "") {
        suggestionsBox.innerHTML = "";
        suggestionsBox.classList.remove('active'); // Hide suggestions
        return; // Exit if the query is empty
    }

    // Call the Mapbox Geocoding endpoint
    fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${query}.json?access_token=${accessToken}&types=place,region,country`)
        .then(response => response.json())
        .then(data => {
            // Check if features are available
            if (data.features && data.features.length > 0) {
                suggestionsBox.classList.add('active'); // Show suggestions
                suggestionsBox.innerHTML = "";

                const suggestions = data.features;
                suggestions.forEach(suggestion => {
                    // Create suggestion text
                    const placeName = suggestion.place_name;
                    const suggestionItem = document.createElement('div');
                    suggestionItem.classList.add('suggestion-item'); // Assign class
                    
                    // Create and add location icon
                    const iconElement = document.createElement('img');
                    iconElement.src = 'https://uploads-ssl.webflow.com/64ccebfb87c59cf5f3e54ed9/64d2833fff1d33088ebee8f4_cycling-icon-50.svg'; // Change this path
                    suggestionItem.appendChild(iconElement);

                    suggestionItem.appendChild(document.createTextNode(placeName));
                    suggestionsBox.appendChild(suggestionItem);

                    // Add click event listener to each suggestion
                    suggestionItem.addEventListener('click', () => {
                        // Populate the search bar with the selected suggestion
                        searchInput.value = placeName;
                        // Clear the suggestions
                        suggestionsBox.innerHTML = "";
                        suggestionsBox.classList.remove('active'); // Hide suggestions
                    });
                });
            } else {
                suggestionsBox.classList.remove('active'); // Hide suggestions
            }
        })
        .catch(error => console.error(error));
});
</script>
